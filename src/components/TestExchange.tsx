import React, { useMemo } from 'react';
import { BrowserProvider, ethers, JsonRpcSigner } from 'ethers';
import axios from 'axios';
import {
  Config,
  useAccount,
  useConnectorClient,
  useSendTransaction,
} from 'wagmi';
import config from '@/config/configuration';
import { sign } from 'crypto';
import { Account, Chain, Client, Transport } from 'viem';
import { getConnectorClient } from '@wagmi/core';
import { wagmiConfig } from '@/config/wagmi';

const integratorId: string =
  'test-project-4ba94915-f432-4d42-89df-53c6de4dd93e';

// Define chain and token addresses
const fromChainId = '137'; // Polygon
const toChainId = '137'; // Polygon
const fromToken = '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359';
const toToken = '0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee'; // USDC

const url = config.NETWORK_RPC_ADDRESS;
const provider = new ethers.JsonRpcProvider('https://base.llamarpc.com');

// Define the amount to be sent
const amount = '10000000';

export function clientToSigner(client: Client<Transport, Chain, Account>) {
  const { account, chain, transport } = client;
  const network = {
    chainId: chain.id,
    name: chain.name,
    ensAddress: chain.contracts?.ensRegistry?.address,
  };
  const provider = new BrowserProvider(transport, network);
  const signer = new JsonRpcSigner(provider, account.address);
  return signer;
}

export async function getEthersSigner({ chainId }: { chainId?: number } = {}) {
  const client = await getConnectorClient(wagmiConfig, { chainId });
  return clientToSigner(client);
}

export const getRoute = async (params: any) => {
  try {
    const result = await axios.post(
      'https://apiplus.squidrouter.com/v2/route',
      params,
      {
        headers: {
          'x-integrator-id': integratorId,
          'Content-Type': 'application/json',
        },
      },
    );
    const requestId = result.headers['x-request-id'];
    return { data: result.data, requestId: requestId };
  } catch (error: any) {
    if (error.response) {
      console.error('API error:', error.response.data);
    }
    console.error('Error with parameters:', params);
    throw error;
  }
};

const getStatus = async (params: any) => {
  try {
    const result = await axios.get(
      'https://apiplus.squidrouter.com/v2/status',
      {
        params: {
          transactionId: params.transactionId,
          requestId: params.requestId,
          fromChainId: params.fromChainId,
          toChainId: params.toChainId,
        },
        headers: {
          'x-integrator-id': integratorId,
        },
      },
    );
    return result.data;
  } catch (error) {
    console.log('Error');
  }
};

// Function to periodically check the transaction status until it completes
const updateTransactionStatus = async (txHash: string, requestId: string) => {
  const getStatusParams = {
    transactionId: txHash,
    requestId: requestId,
    fromChainId: fromChainId,
    toChainId: toChainId,
  };

  let status;
  const completedStatuses = [
    'success',
    'partial_success',
    'needs_gas',
    'not_found',
  ];
  const maxRetries = 10; // Maximum number of retries for status check
  let retryCount = 0;

  do {
    try {
      status = await getStatus(getStatusParams);
      console.log(`Route status: ${status.squidTransactionStatus}`);
    } catch (error: any) {
      if (error.response && error.response.status === 404) {
        retryCount++;
        if (retryCount >= maxRetries) {
          console.error('Max retries reached. Transaction not found.');
          break;
        }
        console.log('Transaction not found. Retrying...');
        await new Promise(resolve => setTimeout(resolve, 5000)); // Wait for 5 seconds before retrying
        continue;
      } else {
        throw error; // Rethrow other errors
      }
    }

    if (!completedStatuses.includes(status.squidTransactionStatus)) {
      await new Promise(resolve => setTimeout(resolve, 5000)); // Wait for 5 seconds before checking the status again
    }
  } while (!completedStatuses.includes(status.squidTransactionStatus));
};

const TestExchange = () => {
  // Function to approve the transactionRequest.target to spend fromAmount of fromToken
  const approveSpending = async (
    transactionRequestTarget: string,
    fromToken: string,
    fromAmount: string,
  ) => {
    const erc20Abi = [
      'function approve(address spender, uint256 amount) public returns (bool)',
    ];

    let provider = new ethers.BrowserProvider(window.ethereum);

    // It also provides an opportunity to request access to write
    // operations, which will be performed by the private key
    // that MetaMask manages for the user.
    let signer = await provider.getSigner();

    const tokenContract = new ethers.Contract(fromToken, erc20Abi, signer);

    try {
      const tx = await tokenContract.approve(
        transactionRequestTarget,
        fromAmount,
      );
      await tx.wait();
      console.log(
        `Approved ${fromAmount} tokens for ${transactionRequestTarget}`,
      );
    } catch (error) {
      console.error('Approval failed:', error);
      throw error;
    }
  };

  const executeSwap = async () => {
    console.log('SDs');
    // console.log(window.ethereum);
    const signer = await getEthersSigner();
    console.log(signer, 'testProvider');

    // let provider = new ethers.BrowserProvider(window.ethereum);

    // It also provides an opportunity to request access to write
    // operations, which will be performed by the private key
    // that MetaMask manages for the user.

    // const signer = await provider.getSigner();
    console.log(signer);

    // const tx = await signer.sendTransaction({
    //   from: '0x4ce6B0F604E1036AFFD0826764b51Fb72310964c',
    //   to: '0x0000000000000000000000000000000000000000',
    //   data: '0x095ea7b30000000000000000000000008d855d10721d19ad8c9f703745e17be5c38b857d0000000000000000000000000000000000000000000000008ac7230489e80000',
    // });
    // console.log('Sign Transaction Hash:', tx.hash);

    // const sendTx = await signer.sendTransaction({
    //   from: '0x4ce6B0F604E1036AFFD0826764b51Fb72310964c',
    //   to: '0x8D855D10721d19AD8c9f703745e17be5C38B857D',
    //   value: '0x91b77e5e5d9a0000',
    //   // gas: "0x04dbb1",
    //   data: '0x47fff239000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000d800000000000000000000000002e555fcf3a9a91c2971c6205d3f8f42cbbfc9d5a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ac7230489e8000000000000000000000000000000000000000000000000000000000000002edf6100000000000000000000000000000000000000000000000000000000002ed82d0000000000000000000000000000000000000000000000000000000000287ce900000000000000000000000000000000000000000000000006f05b59d3b2000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000e200000000000000000000000000000000000000000000000000000000000000e40000000000000000000000000000000000000000000000000000000000000186000000000000000000000000000000000000000000000000000000000000012c1b51a718f891b6a41562204b5e2aeff88b2c0dba087dba27dea18ef4df89dad916465627269646765000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000188000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c335900000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000def171fe48cf0115b1d80b88dc8eab59176fee57000000000000000000000000216b4b4ba9f3e719726886d34a177484278bfcae000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000009e4a94e78ef0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000000000000000008ac7230489e8000000000000000000000000000000000000000000000000000000000000002d776600000000000000000000000000000000000000000000000000000000002edf610000000000000000000000008d855d10721d19ad8c9f703745e17be5c38b857d00000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000067ab63a8160676a6085c45e38085d773efb6210e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000003200000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f6190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000e44769f42e1e9592f86b82f206407a8f7c84b4ed00000000000000000000000000000000000000000000000000000000000027100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000034d41ce301257a4615d4f5ad260fa91d03925243000000000000000000000000000000000000000000000000000000000000271000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000067b34ca8000000000000000000000000000000000000000000000000000000000000002b0d500b1d8e8ef31e21c99d1db9a6444d3adf12700001f47ceb23fd6bc0add59e62ac25578270cff1b9f6190000000000000000000000000000000000000000000000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c33590000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000e44769f42e1e9592f86b82f206407a8f7c84b4ed000000000000000000000000000000000000000000000000000000000000271000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000009000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c8000000000000000000000000000000000000000000000000000000000000271000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000def171fe48cf0115b1d80b88dc8eab59176fee570000000000000000000000000000000000000000000000000000000000000000000000000000000000000000def171fe48cf0115b1d80b88dc8eab59176fee57000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000067b34ca8000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000201dcea0bfbbe6848f117640d534c9b60f41b9f2a8000100000000000000000ea10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000041f0d42f0912d00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f6190000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c335900000000000000000000000000000000000000000000000000000000000000027fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009e4a94e78ef0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000000000000000008ac7230489e8000000000000000000000000000000000000000000000000000000000000002d776600000000000000000000000000000000000000000000000000000000002edf610000000000000000000000008d855d10721d19ad8c9f703745e17be5c38b857d00000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000067ab63a8160676a6085c45e38085d773efb6210e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000003200000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f6190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000e44769f42e1e9592f86b82f206407a8f7c84b4ed00000000000000000000000000000000000000000000000000000000000027100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000034d41ce301257a4615d4f5ad260fa91d03925243000000000000000000000000000000000000000000000000000000000000271000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000067b34ca8000000000000000000000000000000000000000000000000000000000000002b0d500b1d8e8ef31e21c99d1db9a6444d3adf12700001f47ceb23fd6bc0add59e62ac25578270cff1b9f6190000000000000000000000000000000000000000000000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c33590000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000e44769f42e1e9592f86b82f206407a8f7c84b4ed000000000000000000000000000000000000000000000000000000000000271000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000009000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c8000000000000000000000000000000000000000000000000000000000000271000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000def171fe48cf0115b1d80b88dc8eab59176fee570000000000000000000000000000000000000000000000000000000000000000000000000000000000000000def171fe48cf0115b1d80b88dc8eab59176fee57000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000067b34ca8000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000201dcea0bfbbe6848f117640d534c9b60f41b9f2a8000100000000000000000ea10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000041f0d42f0912d00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f6190000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c335900000000000000000000000000000000000000000000000000000000000000027fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c335900000000000000000000000000000000000000000000000000000000002ed82d00000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000287ce9000000000000000000000000000000000000000000000000000000000000210500000000000000000000000000000000000000000000000000000000000001a00000000000000000000000004ce6b0f604e1036affd0826764b51fb72310964c00000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000014833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000000000000000000000000000000142e555fcf3a9a91c2971c6205d3f8f42cbbfc9d5a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000142e555fcf3a9a91c2971c6205d3f8f42cbbfc9d5a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
    //   // gasPrice: '0x04dbb1',
    // });
    // console.log(' Send Transaction Hash:', sendTx.hash);

    // try {

    const params = {
      fromAddress: signer.address,
      fromChain: fromChainId,
      fromToken: fromToken,
      fromAmount: amount,
      toChain: toChainId,
      toToken: toToken,
      toAddress: '0x2E555fCf3A9a91C2971C6205D3f8F42Cbbfc9d5A',
    };

    console.log('Parameters:', params);

    //   // Get the swap route using Squid API
    const routeResult = await getRoute(params);
    const route = routeResult.data.route;
    const requestId = routeResult.requestId;
    console.log('Route Result', routeResult);
    console.log('Calculated route:', route);
    console.log('requestId:', requestId);

    const transactionRequest = route.transactionRequest;

    // //   // If not using native token, approve spending
    await approveSpending(transactionRequest.target, fromToken, amount);

    // console.log('===', transactionRequest);
    const tx = await signer.sendTransaction({
      to: transactionRequest.target,
      data: transactionRequest.data,
      value: transactionRequest.value,
      gasPrice: (await provider.getFeeData()).gasPrice,
      gasLimit: transactionRequest.gasLimit,
    });
    // console.log('Transaction Hash:', tx.hash);
    // const txReceipt = await tx.wait();
    // console.log(`Finished! Check Axelarscan for details: ${txReceipt}`);

    // if (txReceipt) {
    //   console.log(txReceipt);
    //   await updateTransactionStatus(txReceipt?.hash, requestId);
    // } //   // // Update transaction status

    //   return 'some data';
    // } catch (error) {
    //   console.error('Error in executeSwap:', error);
    //   throw error;
    // }
  };

  return (
    <div>
      TestExchange
      <button onClick={executeSwap}> Click</button>
    </div>
  );
};

export default TestExchange;
